import { NextResponse } from 'next/server';
import { generatePoem } from '@/lib/openai';

const CIPAI_OPTIONS = [
   {
      name: "江城子",
      value: `1. 苏轼《江城子·乙卯正月二十日夜记梦》
   十年生死两茫茫，不思量，自难忘。
   千里孤坟，无处话凄凉。
   纵使相逢应不识，尘满面，鬓如霜。
   
   夜来幽梦忽还乡，小轩窗，正梳妆。
   相顾无言，惟有泪千行。
   料得年年肠断处，明月夜，短松冈。

2. 辛弃疾《江城子·密州出猎》
   老夫聊发少年狂，左牵黄，右擎苍。
   锦帽貂裘，千骑卷平冈。
   为报倾城随太守，亲射虎，看孙郎。
   
   酒酣胸胆尚开张，鬓微霜，又何妨？
   持节云中，何日遣冯唐？
   会挽雕弓如满月，西北望，射天狼。`
   },
   {
      name: "水调歌头", value: `1. 苏轼《水调歌头·明月几时有》(中秋)
   明月几时有？把酒问青天。
   不知天上宫阙，今夕是何年。
   我欲乘风归去，又恐琼楼玉宇，高处不胜寒。
   起舞弄清影，何似在人间。
   
   转朱阁，低绮户，照无眠。
   不应有恨，何事长向别时圆？
   人有悲欢离合，月有阴晴圆缺，此事古难全。
   但愿人长久，千里共婵娟。

2. 辛弃疾《水调歌头·遥望中秋》
   瑶台十二春，玉树几生花。
   珠帘夜卷，罗幕晓垂，风露澹清华。
   天上人间，一样风月天涯。
   惟有相思无尽处，不在千里，不在天涯。
   
   风雨送春归，飞雪迎春到。
   已是悬崖百丈冰，犹有花枝俏。
   俏也不争春，只把春来报。
   待到山花烂漫时，她在丛中笑。

3. 陆游《水调歌头·送章德茂大卿使虏》
   凤凰山下雨初晴，水风清，晓莺声。
   千古兴亡多少事，悠悠都付笑谈中。
   江山如画，一时多少豪杰。
   遥想公瑾当年，小乔初嫁了，雄姿英发。
   
   羽扇纶巾，谈笑间、樯橹灰飞烟灭。
   故国神游，多情应笑我，早生华发。
   人生如梦，一尊还酹江月。
   把酒问青天，此事何如？

4. 周邦彦《水调歌头·江上春山远》
   江上春山远，云锁暮霭深。
   风细细，雨纤纤，愁绪难禁。
   花径不堪行，芳草年年与，相思又一春。
   天涯旧恨，依约在归心。
   
   夜阑人静，月明如昼，独倚阑干。
   谁家玉笛暗飞声，散入春风满洛城。
   此夜曲中闻折柳，何人不起故园情。
   长记当时，自谓骨肉远，咫尺却天涯。` },
   {
      name: "念奴娇", value: `1. 苏轼《念奴娇·赤壁怀古》
   大江东去，浪淘尽、千古风流人物。
   故垒西边，人道是、三国周郎赤壁。
   乱石穿空，惊涛拍岸，卷起千堆雪。
   江山如画，一时多少豪杰。
   
   遥想公瑾当年，小乔初嫁了，雄姿英发。
   羽扇纶巾，谈笑间、樯橹灰飞烟灭。
   故国神游，多情应笑我，早生华发。
   人生如梦，一尊还酹江月。

2. 辛弃疾《念奴娇·登建康赏心亭》
   千古江山，英雄无觅，孙仲谋处。
   舞榭歌台，风流总被、雨打风吹去。
   斜阳草树，寻常巷陌，人道寄奴曾住。
   想当年，金戈铁马，气吞万里如虎。
   
   元嘉草草，封狼居胥，赢得仓皇北顾。
   四十三年，望中犹记，烽火扬州路。
   可堪回首，佛狸祠下，一片神鸦社鼓。
   凭谁问，廉颇老矣，尚能饭否？

3. 张炎《念奴娇·过洞庭》
   洞庭连天，涵山纳水，气势磅礴。
   鸿飞冥冥，日与云齐，青芜天际阔。
   波撼岳阳城，岁晚长江路，独佇东风破。
   情伤远，目极千里，茫茫无际。
   
   念往昔，龙舟竞渡，诗人横槊。
   雨洗苍烟，露饰秋水，清光摇荡多。
   雁度衡阳，人归洞庭，万里澄江阔。
   烟霞外，一片孤鸿，认取葭苇。

4. 王安石《念奴娇·春日》
   绿杨烟外晓寒轻，红杏枝头春意闹。
   浮生长恨欢娱少，肯爱千金轻一笑。
   为君持酒劝斜阳，且向花间留晚照。
   羞解罗衣，独上兰舟，云净水迢迢。
   
   千古风流人物，正相逢、欲倚江楼。
   天涯芳草无归路，旧国家山带夕阳。
   细想前尘，尽黄粱一梦，不如怜取眼前好。
   长歌倚柱，醉倚吴门，红粉长依旧。` },
   {
      name: "满江红", value: `1. 岳飞《满江红·怒发冲冠》
   怒发冲冠,凭栏处、潇潇雨歇。
   抬望眼,仰天长啸,壮怀激烈。
   三十功名尘与土,八千里路云和月。
   莫等闲,白了少年头,空悲切！
   
   靖康耻,犹未雪。臣子恨,何时灭！
   驾长车,踏破贺兰山缺。
   壮志饥餐胡虏肉,笑谈渴饮匈奴血。
   待从头,收拾旧山河,朝天阙。

2. 辛弃疾《满江红·写怀》
   醉里挑灯看剑,梦回吹角连营。
   八百里分麾下炙,五十弦翻塞外声。
   沙场秋点兵。马作的卢飞快,弓如霹雳弦惊。
   了却君王天下事,赢得生前身后名。
   可怜白发生！

3. 张孝祥《满江红·壬辰元日》
   江东子弟,多才俊,卷土重来未可知。
   休说鲈鱼堪脍,尽西风,季鹰归未?
   廊庙之器推贤达,田野何须困穷士。
   君莫问,廉颇老矣,尚能饭否?

4. 文天祥《满江红·过零丁洋》
   仰天长啸出门去,怀揣丹心,誓灭胡尘。
   莫笑书生无胆略,我辈岂是蓬蒿人。
   料敌若神,雄兵百万,不足踹尔眼中尘。
   俱往矣,数风流人物,还看今日。

5. 吕本中《满江红·怀古》
   东风扫荡,吹残雪、柳塘春晓。
   渐新痕,染遍江南,无处不飘萧。
   千古兴亡多少事,悠悠都付笑谈中。
   闲看罢,旧时王谢,飞燕凤楼空。
   
   山河在,人民在,国家谁料?
   想汉家,云台乐府,元宵灯火闹。
   而今犹自歌尧舜,沧海桑田转眼过。
   兴废一,今昔之感,英雄泪满襟。` },
   {
      name: "蝶恋花", value: `1. 柳永《蝶恋花·伫倚危楼风细细》
   伫倚危楼风细细,望极春愁,黯黯生天际。
   草色烟光残照里,无言谁会凭栏意。
   
   拟把疏狂图一醉,对酒当歌,强乐还无味。
   衣带渐宽终不悔,为伊消得人憔悴。

2. 苏轼《蝶恋花·春景》
   花褪残红青杏小,燕子飞时,绿水人家绕。
   枝上柳绵吹又少,天涯何处无芳草。
   
   墙里秋千墙外道,墙外行人,墙里佳人笑。
   笑渐不闻声渐悄,多情却被无情恼。

3. 李清照《蝶恋花·暖日晴风初破冻》
   暖日晴风初破冻,柳眼梅腮,已觉春心动。
   酒意诗情谁与共,泪融残粉花钿重。
   
   乍试夹衫金缕缝,山枕斜欹,枕损钗头凤。
   独抱琵琶寻旧弄,断肠移破秋萝恸。

4. 秦观《蝶恋花·阅尽天涯离别苦》
   阅尽天涯离别苦,不道归来,零落花如许。
   花底相看无一语,绿窗春与天俱莫。
   
   待把相思灯下诉,一缕新欢,旧恨千千缕。
   最是人间留不住,朱颜辞镜花辞树。

5. 晏殊《蝶恋花·槛菊愁烟兰泣露》
   槛菊愁烟兰泣露,罗幕轻寒,燕子双飞去。
   明月不谙离恨苦,斜光到晓穿朱户。
   
   昨夜西风凋碧树,独上高楼,望尽天涯路。
   欲寄彩笺兼尺素,山长水阔知何处。` },
   {
      name: "西江月", value: `1. 苏轼《西江月·世事一场大梦》
   世事一场大梦,人生几度秋凉。
   夜来风叶已鸣廊,看取眉头鬓上。
   酒贱常愁客少,月明多被云妨。
   中秋谁与共孤光,把盏凄然北望。

2. 辛弃疾《西江月·夜行黄沙道中》
   明月别枝惊鹊,清风半夜鸣蝉。
   稻花香里说丰年,听取蛙声一片。
   七八个星天外,两三点雨山前。
   旧时茅店社林边,路转溪桥忽见。

3. 李清照《西江月·新词格》
   红藕香残玉簟秋。轻解罗裳,独上兰舟。
   云中谁寄锦书来,雁字回时,月满西楼。
   花自飘零水自流。一种相思,两处闲愁。
   此情无计可消除,才下眉头,却上心头。

4. 张孝祥《西江月·阻风山峰下作》
   山峰阻风雨,归路隔江天。
   独坐无人语,空帘不卷烟。
   愁眉收不尽,老泪洒横斜。
   却笑当年事,相逢是梦间。` },
   {
      name: "卜算子", value: `1. 苏轼《卜算子·黄州定慧院寓居作》
   缺月挂疏桐,漏断人初静。
   谁见幽人独往来,缥缈孤鸿影。

   惊起却回头,有恨无人省。
   拣尽寒枝不肯栖,寂寞沙洲冷。

2. 李之仪《卜算子·我住长江头》
   我住长江头,君住长江尾。
   日日思君不见君,共饮长江水。

   此水几时休,此恨何时已。
   只愿君心似我心,定不负相思意。

3. 毛泽东《卜算子·咏梅》
   风雨送春归,飞雪迎春到。
   已是悬崖百丈冰,犹有花枝俏。

   俏也不争春,只把春来报。
   待到山花烂漫时,她在丛中笑。

4. 辛弃疾《卜算子·咏梅》
   驿外断桥边,寂寞开无主。
   已是黄昏独自愁,更著风和雨。

   无意苦争春,一任群芳妒。
   零落成泥碾作尘,只有香如故。` },
];
function getPoemValueByName(name: string): string | undefined {
   const option = CIPAI_OPTIONS.find(opt => opt.name === name);
   return option ? option.value : undefined;
}

export async function POST(req: Request) {
   const { author, cipai, prompt } = await req.json();
   const fullPrompt = `你是一个专业的宋词大师，精通作词，尤其是深入研究了宋词的韵律，声调，请按照给定词牌的韵律，字数要求。写一首 ${cipai}

创作者：
${author}

参考：
${getPoemValueByName(cipai)}

要求：
${prompt}

参考输出格式：
词牌·词的主题
朝代·作者
正文
要求：
词的主题：一般三四个字
朝代：如果创作者没有提供，则是“当代”
作者：就是创作者，如果没有提供，是“无名氏”
正文：根据对词牌的理解，进行合理的分段。

例如：
卜算子·咏梅（一般三四个字）
宋·辛弃疾

驿外断桥边,寂寞开无主。
已是黄昏独自愁,更著风和雨。

无意苦争春,一任群芳妒。
零落成泥碾作尘,只有香如故。

结果（参考输出格式，不要做任何解析）：
`
   console.log(prompt)
   const stream = await generatePoem(cipai, fullPrompt);

   const encoder = new TextEncoder();
   const readable = new ReadableStream({
      async start(controller) {
         for await (const chunk of stream) {
            const text = chunk.choices[0]?.delta?.content || '';
            controller.enqueue(encoder.encode(text));
         }
         controller.close();
      },
   });

   return new NextResponse(readable, {
      headers: { 'Content-Type': 'text/plain; charset=utf-8' },
   });
}